## 1，在sysmaster库中创建黑名单表  
```sql
-- create tabble black ip list（in sysmaster）
DROP TABLE IF EXISTS blackiplist;
CREATE TABLE blackiplist(
  id serial NOT NULL,
  iptype SMALLINT DEFAULT 0,
  ipstart varchar(20),
  ipstart_num int8,
  ipstop  varchar(20),
  ipstop_num  int8,
  updatetime datetime YEAR TO SECOND DEFAULT CURRENT YEAR TO SECOND,
  PRIMARY key(id)
);
CREATE UNIQUE INDEX ix_blackiplist_ip ON blackiplist(ipstart,ipstop,iptype);

/*
comment ON COLUMN blackiplist.iptype IS '0:单IP;1:IP段';
comment ON COLUMN blackiplist.ipstart IS '开始IP';
comment ON COLUMN blackiplist.ipstop IS '结束IP';
comment ON COLUMN blackiplist.ipstart IS '开始IP（数值写法）';
comment ON COLUMN blackiplist.ipstop IS '结束IP（数值写法）';
*/
```

## 2,在sysmaster库中创建相应的函数、触发器等  
检查是否为IP的函数且转为数值（用于IP区段判断）
```sql
-- function ip to num, if not ip return -1
DROP FUNCTION IF EXISTS func_ip2num(varchar);
CREATE FUNCTION func_ip2num(p_ip varchar(20))
RETURNS int8 WITH (NOT VARIANT);
  define v_ip1 varchar(10);
  define v_ip2 varchar(10);
  define v_ip3 varchar(10);
  define v_ip4 varchar(10);
  define v_ipnum int8;
  define v_delpos smallint;
  define v_curpos smallint;
  ON EXCEPTION
    RETURN -1;
  END EXCEPTION;

  let v_ipnum = -1;
  -- ip part1
  let v_delpos = charindex('.',p_ip);
  let v_ip1 = substr(p_ip,1,v_delpos - 1)::int;
  -- ip part2
  let v_curpos = v_delpos + 1;
  let v_delpos = charindex('.',p_ip,v_curpos);
  let v_ip2 = substr(p_ip,v_curpos,v_delpos - v_curpos)::int;
  -- ip part3
  let v_curpos = v_delpos + 1;
  let v_delpos = charindex('.',p_ip,v_curpos);
  let v_ip3 = substr(p_ip,v_curpos,v_delpos - v_curpos)::int; 
  -- ip part4
  let v_curpos = v_delpos + 1;
  let v_ip4 = substr(p_ip,v_curpos)::int;
  IF v_ip1 < 0 OR v_ip2 < 0 OR v_ip3 < 0 OR v_ip4 < 0 OR
     v_ip1 > 255 OR v_ip2 > 255 OR v_ip3 > 255 OR v_ip4 > 255 THEN
    RETURN -1;
  END IF;
  let v_ipnum = v_ip1 * 16777216 + v_ip2 * 65536 + v_ip3 * 256 + v_ip4;
  
  RETURN v_ipnum;
END FUNCTION;
```
触发器及触发存储过程
```sql
DROP PROCEDURE IF EXISTS proc_tri_iou_blackiplist();
CREATE PROCEDURE proc_tri_iou_blackiplist()
referencing NEW AS NEW OLD AS OLD for blackiplist;

  let NEW.ipstart_num = func_ip2num(NEW.ipstart);
  let NEW.ipstop_num = func_ip2num(NEW.ipstop);
  let NEW.updatetime = CURRENT YEAR TO SECOND;
  IF NEW.iptype = 0 THEN 
    IF NEW.ipstart_num = -1 THEN
      RAISE EXCEPTION 1277;
    END IF;
  ELSE
    IF NEW.ipstart_num = -1 OR NEW.ipstop_num = -1 THEN
      RAISE EXCEPTION 1277;
    END IF;      
  END IF;
  
END PROCEDURE;

DROP TRIGGER IF EXISTS tri_insert_blackiplist;
CREATE TRIGGER tri_insert_blackiplist insert on blackiplist
FOR EACH ROW(
  execute procedure proc_tri_iou_blackiplist() with trigger references
);

DROP TRIGGER IF EXISTS tri_update_blackiplist;
CREATE TRIGGER tri_update_blackiplist UPDATE ON blackiplist
FOR EACH ROW(
  execute procedure proc_tri_iou_blackiplist() with trigger references
);
```

## 3，在sysmaster库中创建登陆检查IP函数  
```sql
DROP PROCEDURE IF EXISTS checkip();
CREATE PROCEDURE checkip()
  define v_sesid int;
  define v_hostname VARCHAR(255);
  define v_isblack int;
  
  let v_isblack = 0;
  let v_sesid = DBINFO('sessionid');
  SELECT s.hostname 
  INTO v_hostname 
  FROM sysmaster:syssessions s
  WHERE s.sid = v_sesid;
  
  SELECT count(*) 
  INTO v_isblack
  FROM sysmaster:blackiplist
  WHERE (iptype = 0 AND ipstart = v_hostname) OR
  (iptype = 1 AND ipstart_num <= func_ip2num(v_hostname) AND ipstop_num >= func_ip2num(v_hostname));
  
  IF v_isblack > 0 THEN 
    EXECUTE FUNCTION sysadmin:task('onmode','z',v_sesid) INTO v_hostname;
  END IF;
END PROCEDURE;
```
## 4，在sysmaster库中插入指定黑名单数据  
```sql
-- 单IP
insert into blackiplist(iptype,ipstart) values(0,'192.168.0.100');
-- IP段
insert into blackiplist(iptype,ipstart,ipstop) values(1,'192.168.1.0','192.168.1.255');
```

## 5，在所有库或者需要限制的库中创建sysdbopen过程
对于所有用户，使用public.sysdbopen。对于指定用户，可以使用 用户名.sysdbopen。
```sql
-- sysdbopen
DROP PROCEDURE IF EXISTS public.sysdbopen();
CREATE PROCEDURE public.sysdbopen()
  CALL sysmaster:checkip();
END PROCEDURE;
```

## 测试  
符合黑名单记录的IP+用户登陆数据库，将报网络断开错误（如 -79716）。
